<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - A S GURU ACADEMY</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            margin-top: 20px;
            margin-bottom: 20px;
        }

        .admin-container {
            background: white;
            max-width: 1200px;
            margin: 0 auto;
            border-radius: 15px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            animation: fadeIn 0.5s ease-in-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .admin-header {
            background: linear-gradient(135deg, #ff6b35 0%, #e55a2b 100%);
            color: white;
            padding: 30px;
            position: relative;
            text-align: center;
        }

        .header-controls {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
        }

        .control-btn {
            padding: 8px 16px;
            border: 2px solid white;
            background: transparent;
            color: white;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .control-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        .control-btn.logout {
            border-color: #ffffff;
            color: #ffffff;
        }

        .control-btn.logout:hover {
            background: rgba(231, 76, 60, 0.1);
        }

        .admin-title {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            padding-top: 20px;
        }

        .admin-subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
            margin-bottom: 20px;
        }

        .welcome-section {
            background: #f8f9fa;
            padding: 20px 30px;
            text-align: center;
        }

        .welcome-message {
            color: #2c3e50;
            font-size: 1.2rem;
            margin-bottom: 15px;
        }

        .user-info {
            color: #7f8c8d;
            font-size: 1rem;
            margin-bottom: 10px;
        }

        .admin-content {
            padding: 30px;
            background: white;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #27ae60;
            margin-right: 8px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .footer-info {
            background: #f8f9fa;
            padding: 20px 30px;
            text-align: center;
            border-top: 1px solid #e9ecef;
            color: #6c757d;
            font-size: 0.9rem;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .loading-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #ff6b35;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .empty-state {
            color: #7f8c8d;
            font-size: 1.2rem;
            font-style: italic;
        }

        /* Events Section Styles */
        .events-section {
            margin-top: 40px;
            border-top: 2px solid #f1f1f1;
            padding-top: 30px;
        }

        .section-title {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.8rem;
            font-weight: 700;
            text-align: center;
            border-bottom: 3px solid #ff6b35;
            padding-bottom: 10px;
            display: inline-block;
            width: 100%;
        }

        .events-form {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
            border: 1px solid #e9ecef;
        }

        .form-title {
            color: #2c3e50;
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 25px;
            text-align: center;
            padding-bottom: 15px;
            border-bottom: 2px solid #f8f9fa;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        .form-group label {
            color: #2c3e50;
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: white;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #ff6b35;
            box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.1);
        }

        .form-group input[type="file"] {
            padding: 8px;
            border: 2px dashed #e9ecef;
            background: #f8f9fa;
        }

        .image-preview {
            margin-top: 15px;
            display: flex;
            justify-content: center;
        }

        .preview-item {
            position: relative;
            width: 200px;
            height: 200px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            background: #f8f9fa;
        }

        .preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .preview-item .remove-image {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 30px;
            height: 30px;
            background: rgba(231, 76, 60, 0.9);
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .preview-item .remove-image:hover {
            background: #e74c3c;
            transform: scale(1.1);
        }

        .post-btn {
            background: linear-gradient(135deg, #ff6b35 0%, #e55a2b 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 20px;
            width: 100%;
        }

        .post-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255, 107, 53, 0.3);
        }

        .post-btn:disabled {
            background: #95a5a6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .status-message {
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            font-weight: 600;
            text-align: center;
        }

        .status-message.success {
            background-color: #d4edda;
            color: #155724;
            border: 2px solid #c3e6cb;
        }

        .status-message.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 2px solid #f5c6cb;
        }

        .events-list {
            margin-top: 30px;
        }

        .events-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .event-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            transition: all 0.3s ease;
            border: 1px solid #e9ecef;
        }

        .event-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.15);
        }

        .event-poster {
            width: 100%;
            height: 200px;
            object-fit: cover;
            background: #f8f9fa;
        }

        .event-info {
            padding: 20px;
        }

        .event-name {
            font-size: 1.2rem;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .event-details {
            color: #7f8c8d;
            font-size: 14px;
            margin-bottom: 8px;
        }

        .event-details strong {
            color: #2c3e50;
        }

        .event-actions {
            padding: 15px 20px;
            background: #f8f9fa;
            border-top: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .delete-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .delete-btn:hover {
            background: #c0392b;
            transform: translateY(-1px);
        }

        .no-events {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
            font-style: italic;
            font-size: 1.1rem;
        }

        /* Character count styles */
        .char-count {
            font-size: 12px;
            color: #666;
            text-align: right;
            margin-top: 5px;
        }

        .char-count.warning {
            color: #ff6b35;
        }

        .char-count.error {
            color: #e74c3c;
        }

        /* MEMBERSHIP CONTROL STYLES */
        .membership-section {
            margin-top: 40px;
            border-top: 2px solid #f1f1f1;
            padding-top: 30px;
        }

        .membership-container {
            background: #1a1a1a;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .membership-title {
            color: #ffffff;
            font-size: 1.8rem;
            font-weight: 700;
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 2px solid #ff6b35;
        }

        .applications-section, .members-section {
            margin-bottom: 30px;
        }

        .section-subtitle {
            color: #ffffff;
            font-size: 1.4rem;
            font-weight: 600;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #333;
        }

        .applications-list, .members-list {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #333;
            border-radius: 10px;
            padding: 15px;
            background: #2a2a2a;
        }

        .application-item, .member-item {
            background: #333;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 4px solid #ff6b35;
        }

        .application-item:last-child, .member-item:last-child {
            margin-bottom: 0;
        }

        .application-header, .member-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .application-number, .member-id {
            color: #ff6b35;
            font-weight: 700;
            font-size: 1.1rem;
        }

        .application-date, .member-date {
            color: #999;
            font-size: 0.9rem;
        }

        .application-details, .member-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .detail-item {
            color: #ffffff;
            font-size: 0.95rem;
        }

        .detail-label {
            color: #ff6b35;
            font-weight: 600;
            margin-right: 8px;
        }

        .application-actions, .member-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .approve-btn, .reject-btn, .whatsapp-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .approve-btn {
            background: #27ae60;
            color: white;
        }

        .approve-btn:hover {
            background: #219a52;
            transform: translateY(-1px);
        }

        .reject-btn {
            background: #e74c3c;
            color: white;
        }

        .reject-btn:hover {
            background: #c0392b;
            transform: translateY(-1px);
        }

        .whatsapp-btn {
            background: #25d366;
            color: white;
        }

        .whatsapp-btn:hover {
            background: #20b658;
            transform: translateY(-1px);
        }

        .no-applications, .no-members {
            text-align: center;
            color: #999;
            font-style: italic;
            padding: 40px;
            font-size: 1.1rem;
        }

        .loading-message {
            text-align: center;
            color: #999;
            padding: 20px;
            font-style: italic;
        }

        /* Filter Members Section Styles */
        .filter-section {
            margin-bottom: 30px;
            padding: 20px;
            background: #2a2a2a;
            border-radius: 10px;
            border: 1px solid #333;
        }

        .filter-row {
            margin-bottom: 20px;
        }

        .filter-row:last-child {
            margin-bottom: 0;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        .filter-group label {
            color: #ff6b35;
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .input-with-button {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .filter-group input,
        .filter-group select {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid #444;
            border-radius: 8px;
            background: #333;
            color: #ffffff;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .filter-group input:focus,
        .filter-group select:focus {
            outline: none;
            border-color: #ff6b35;
            box-shadow: 0 0 0 3px rgba(255, 107, 53, 0.1);
        }

        .filter-group input::placeholder {
            color: #999;
        }

        .search-btn {
            background: linear-gradient(135deg, #ff6b35 0%, #e55a2b 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .search-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(255, 107, 53, 0.3);
        }

        .reset-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .reset-btn:hover {
            background: #5a6268;
            transform: translateY(-1px);
        }

        .search-message {
            margin-top: 10px;
            padding: 10px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            text-align: center;
            display: none;
        }

        .search-message.error {
            background-color: rgba(231, 76, 60, 0.1);
            color: #e74c3c;
            border: 1px solid rgba(231, 76, 60, 0.3);
            display: block;
        }

        .search-message.success {
            background-color: rgba(39, 174, 96, 0.1);
            color: #27ae60;
            border: 1px solid rgba(39, 174, 96, 0.3);
            display: block;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background-color: white;
            margin: 15% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 400px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .modal-content h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.4rem;
        }

        .modal-content p {
            color: #7f8c8d;
            margin-bottom: 25px;
            font-size: 1.1rem;
        }

        .modal-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .modal-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 80px;
        }

        .confirm-btn {
            background: #e74c3c;
            color: white;
        }

        .confirm-btn:hover {
            background: #c0392b;
        }

        .cancel-btn {
            background: #95a5a6;
            color: white;
        }

        .cancel-btn:hover {
            background: #7f8c8d;
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .admin-container {
                margin: 10px;
                border-radius: 10px;
            }

            .admin-header {
                padding: 25px 20px;
            }

            .header-controls {
                position: static;
                margin-top: 20px;
                margin-bottom: 20px;
                gap: 50px;
                justify-content: center;
            }

            .admin-title {
                font-size: 1.8rem;
                padding-top: 0;
            }

            .admin-subtitle {
                font-size: 1rem;
            }

            .admin-content,
            .welcome-section,
            .footer-info {
                padding: 20px 15px;
            }

            .control-btn {
                padding: 6px 12px;
                font-size: 12px;
            }

            .form-row {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .events-grid {
                grid-template-columns: 1fr;
            }

            .events-form {
                padding: 20px;
            }

            .preview-item {
                width: 150px;
                height: 150px;
            }

            .membership-container {
                padding: 20px;
            }
            
            .application-details, .member-details {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .application-actions, .member-actions {
                flex-direction: column;
            }
            
            .approve-btn, .reject-btn, .whatsapp-btn {
                width: 100%;
                margin-bottom: 5px;
            }

            .input-with-button {
                flex-direction: column;
                gap: 10px;
            }
            
            .search-btn,
            .reset-btn {
                width: 100%;
            }
            
            .filter-section {
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
    </div>

    <div class="admin-container">
        <div class="admin-header">
            <div class="header-controls">
                <a href="index.html" class="control-btn">
                    ← Go Back
                </a>
                <button onclick="logout()" class="control-btn logout">
                    ← Logout
                </button>
            </div>
            
            <h1 class="admin-title">Admin Dashboard</h1>
            <p class="admin-subtitle">Welcome to your control panel</p>
        </div>

        <div class="welcome-section">
            <p class="welcome-message">
                <span class="status-indicator"></span>
                You are successfully logged in as an administrator
            </p>
            <p class="user-info" id="userInfo">
                Loading user information...
            </p>
        </div>

        <div class="admin-content">
            <!-- Events Management Section -->
            <div class="events-section">
                <h2 class="section-title">Events Management</h2>

                <div class="events-form">
                    <h3 class="form-title">Post Events</h3>
                    <form id="eventsForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="eventName">Event Name</label>
                                <input type="text" id="eventName" required maxlength="40" placeholder="Enter event name (max 40 characters)">
                                <div class="char-count" id="eventNameCount">0/40</div>
                            </div>
                            <div class="form-group">
                                <label for="eventLocation">Event Location</label>
                                <input type="text" id="eventLocation" required placeholder="Enter event location">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="eventMode">Mode</label>
                                <select id="eventMode" required>
                                    <option value="">Select Mode</option>
                                    <option value="online">Online</option>
                                    <option value="offline">Offline</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="registrationLink">Registration Link</label>
                                <input type="url" id="registrationLink" required placeholder="https://forms.google.com/...">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="startDate">Start Date</label>
                                <input type="date" id="startDate" required>
                            </div>
                            <div class="form-group">
                                <label for="endDate">End Date</label>
                                <input type="date" id="endDate" required>
                            </div>
                        </div>

                        <div class="form-group full-width">
                            <label for="posterUpload">Upload Poster</label>
                            <input type="file" id="posterUpload" accept="image/*" required>
                            <div class="image-preview" id="posterPreview"></div>
                        </div>

                        <button type="submit" class="post-btn" id="postEventBtn">Post</button>
                    </form>
                    <div id="eventStatus"></div>
                </div>

                <!-- Videos Management Section Starts -->
                <div class="events-form">
                    <h3 class="form-title">Post Videos</h3>
                    <form id="videosForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="videoTitle">Video Title</label>
                                <input type="text" id="videoTitle" required maxlength="40" placeholder="Enter video title (max 40 characters)">
                                <div class="char-count" id="videoTitleCount">0/40</div>
                            </div>
                            <div class="form-group">
                                <label for="videoLink">YouTube Video Link</label>
                                <input type="url" id="videoLink" required placeholder="https://youtu.be/VIDEO_ID or https://www.youtube.com/watch?v=VIDEO_ID">
                            </div>
                        </div>
                        <button type="submit" class="post-btn" id="postVideoBtn">Post Video</button>
                    </form>
                    <div id="videoStatus"></div>
                </div>

                <div class="events-form">
                    <h3 class="form-title">Post Testimonials</h3>
                    <form id="testimonialsForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="testimonialTitle">Testimonial Title</label>
                                <input type="text" id="testimonialTitle" required maxlength="40" placeholder="Enter testimonial title (max 40 characters)">
                                <div class="char-count" id="testimonialTitleCount">0/40</div>
                            </div>
                            <div class="form-group">
                                <label for="testimonialLink">YouTube Shorts Link</label>
                                <input type="url" id="testimonialLink" required placeholder="https://youtube.com/shorts/VIDEO_ID">
                            </div>
                        </div>
                        <button type="submit" class="post-btn" id="postTestimonialBtn">Post Testimonial</button>
                    </form>
                    <div id="testimonialStatus"></div>
                </div>
                <!-- Videos Management Section Ends -->

                <div class="events-list">
                    <h3 class="section-title">Posted Events</h3>
                    <div class="events-grid" id="eventsGrid">
                        <div class="no-events">Loading events...</div>
                    </div>
                </div>

                <!-- Posted Videos List Starts -->
                <div class="events-list">
                    <h3 class="section-title">Posted Videos</h3>
                    <div class="events-grid" id="videosGrid">
                        <div class="no-events">Loading videos...</div>
                    </div>
                </div>
                <!-- Posted Videos List Ends -->
                
                <!-- Posted Testimonials List Starts -->
                <div class="events-list">
                    <h3 class="section-title">Posted Testimonials</h3>
                    <div class="events-grid" id="testimonialsGrid">
                        <div class="no-events">Loading testimonials...</div>
                    </div>
                </div>
                <!-- Posted Testimonials List Ends -->
            </div>

            <!-- MEMBERSHIP CONTROL SECTION -->
            <div class="membership-section">
                <div class="membership-container">
                    <h2 class="membership-title">Membership Control</h2>
                    
                    <!-- Applications Section -->
                    <div class="applications-section">
                        <h3 class="section-subtitle">Membership Applications</h3>
                        <div class="applications-list" id="applicationsList">
                            <div class="loading-message">Loading applications...</div>
                        </div>
                    </div>
                    
                    <!-- Members Section -->
                    <div class="members-section">
                        <h3 class="section-subtitle">Members</h3>
                        <div class="members-list" id="membersList">
                            <div class="loading-message">Loading members...</div>
                        </div>
                    </div>

                    <!-- Filter Members Section -->
                    <div class="filter-section">
                        <h3 class="section-subtitle">Filter Members</h3>
                        
                        <!-- Card ID Search -->
                        <div class="filter-row">
                            <div class="filter-group">
                                <label for="cardIdInput">Enter Card ID</label>
                                <div class="input-with-button">
                                    <input type="text" id="cardIdInput" placeholder="Enter card ID (e.g., GLD-123-456)">
                                    <button class="search-btn" onclick="searchByCardId()">Search</button>
                                </div>
                                <div class="search-message" id="cardIdMessage"></div>
                            </div>
                        </div>
                        
                        <!-- Card Type Filter -->
                        <div class="filter-row">
                            <div class="filter-group">
                                <label for="cardTypeFilter">Filter</label>
                                <div class="input-with-button">
                                    <select id="cardTypeFilter">
                                        <option value="">All Members</option>
                                        <option value="SILVER">Silver</option>
                                        <option value="GOLD">Gold</option>
                                        <option value="DIAMOND">Diamond</option>
                                        <option value="EMERALD">Emerald</option>
                                        <option value="VIP">VIP</option>
                                    </select>
                                    <button class="search-btn" onclick="filterByCardType()">Search</button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Reset Button -->
                        <div class="filter-row">
                            <button class="reset-btn" onclick="resetFilters()">Show All Members</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="footer-info">
            <p>A S GURU ACADEMY | Last login: <span id="lastLogin">--</span></p>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmationModal" class="modal">
        <div class="modal-content">
            <h3>Confirm Rejection</h3>
            <p>Are you sure you want to reject this application?</p>
            <div class="modal-buttons">
                <button id="confirmRejectBtn" class="modal-btn confirm-btn">Yes</button>
                <button id="cancelRejectBtn" class="modal-btn cancel-btn">No</button>
            </div>
        </div>
    </div>

    <!-- Supabase Script -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.min.js"></script>
    <script>
        // Initialize Supabase client
        const supabaseUrl = "https://csmiziefiecrtxdmahef.supabase.co";
        const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNzbWl6aWVmaWVjcnR4ZG1haGVmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA5MzI4MjYsImV4cCI6MjA2NjUwODgyNn0.foiIv2NTxY60h9uKOtvGA3g1mhkA_8bPormy6_ml_KM";
        const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);
        
        // DOM Elements
        const loadingOverlay = document.getElementById('loadingOverlay');
        const userInfo = document.getElementById('userInfo');
        const lastLogin = document.getElementById('lastLogin');
        
        // Events DOM Elements
        const eventsForm = document.getElementById('eventsForm');
        const eventName = document.getElementById('eventName');
        const eventLocation = document.getElementById('eventLocation');
        const eventMode = document.getElementById('eventMode');
        const startDate = document.getElementById('startDate');
        const endDate = document.getElementById('endDate');
        const registrationLink = document.getElementById('registrationLink');
        const posterUpload = document.getElementById('posterUpload');
        const posterPreview = document.getElementById('posterPreview');
        const eventStatus = document.getElementById('eventStatus');
        const eventsGrid = document.getElementById('eventsGrid');
        const postEventBtn = document.getElementById('postEventBtn');
        
        // Character count elements
        const eventNameCount = document.getElementById('eventNameCount');
        const videoTitleCount = document.getElementById('videoTitleCount');
        const testimonialTitleCount = document.getElementById('testimonialTitleCount');
        
        // Membership Control DOM Elements
        const applicationsList = document.getElementById('applicationsList');
        const membersList = document.getElementById('membersList');
        const confirmationModal = document.getElementById('confirmationModal');
        const confirmRejectBtn = document.getElementById('confirmRejectBtn');
        const cancelRejectBtn = document.getElementById('cancelRejectBtn');
        
        // Event management variables
        let selectedPoster = null;
        let maxEvents = 5;
        
        // Membership Control Variables
        let currentApplicationToReject = null;
        let membershipApplications = [];
        let members = [];
        
        // Filter Members Variables
        let originalMembers = []; // Store original members for reset
        let isFiltered = false;
        
        // Character count functionality
        function setupCharacterCount(input, counter, maxLength) {
            function updateCount() {
                const currentLength = input.value.length;
                counter.textContent = `${currentLength}/${maxLength}`;
                
                if (currentLength > maxLength * 0.9) {
                    counter.className = 'char-count error';
                } else if (currentLength > maxLength * 0.8) {
                    counter.className = 'char-count warning';
                } else {
                    counter.className = 'char-count';
                }
            }
            
            input.addEventListener('input', updateCount);
            updateCount(); // Initial count
        }
        
        // Show loading
        function showLoading() {
            loadingOverlay.classList.add('show');
        }
    
        // Hide loading
        function hideLoading() {
            loadingOverlay.classList.remove('show');
        }
    
        // Logout function
        async function logout() {
            if (confirm('Are you sure you want to logout?')) {
                showLoading();
                
                try {
                    const { error } = await supabaseClient.auth.signOut();
                    if (error) throw error;
                    
                    // Logout successful
                    window.location.href = "login.html";
                } catch (error) {
                    hideLoading();
                    console.error('Logout error:', error);
                    alert('Error logging out. Please try again.');
                }
            }
        }
    
        // Format date for display
        function formatDate(date) {
            return date.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
    
        // Initialize admin dashboard
        async function initializeDashboard(user) {
            // Update user information
            const email = user.email;
            const lastLoginTime = user.last_sign_in_at;
            
            userInfo.textContent = `Logged in as: ${email}`;
            
            if (lastLoginTime) {
                const loginDate = new Date(lastLoginTime);
                lastLogin.textContent = formatDate(loginDate);
            } else {
                lastLogin.textContent = formatDate(new Date());
            }
            
            // Setup events functionality
            setupEventsForm();
            await loadEvents();
            await loadTestimonials();
            await loadVideos();
            await cleanupExpiredEvents();
            
            // Initialize membership control
            await initializeMembershipControl();
        
            // Hide loading overlay
            hideLoading();
        }
        
        // MEMBERSHIP CONTROL FUNCTIONS
        
        // Initialize Membership Control
        async function initializeMembershipControl() {
            await loadApplications();
            await loadMembers();
            await cleanupExpiredMembers();
            
            // Setup modal event listeners
            confirmRejectBtn.addEventListener('click', handleConfirmReject);
            cancelRejectBtn.addEventListener('click', handleCancelReject);
            
            // Close modal when clicking outside
            confirmationModal.addEventListener('click', (e) => {
                if (e.target === confirmationModal) {
                    handleCancelReject();
                }
            });
        }

        // Load Applications from Database
        async function loadApplications() {
            try {
                const { data, error } = await supabaseClient
                    .from('applications')
                    .select('*')
                    .order('application_date_time', { ascending: true });

                if (error) throw error;

                membershipApplications = data;
                renderApplications();

            } catch (error) {
                console.error('Error loading applications:', error);
                applicationsList.innerHTML = `<div class="no-applications">Error loading applications: ${error.message}</div>`;
            }
        }

        // Render Applications
        function renderApplications() {
            if (membershipApplications.length === 0) {
                applicationsList.innerHTML = '<div class="no-applications">No applications yet</div>';
                return;
            }

            applicationsList.innerHTML = membershipApplications.map((app, index) => `
                <div class="application-item">
                    <div class="application-header">
                        <div class="application-number">Application #${index + 1}</div>
                        <div class="application-date">Applied on: ${formatDate(new Date(app.application_date_time))}</div>
                    </div>
                    <div class="application-details">
                        <div class="detail-item">
                            <span class="detail-label">Name:</span>${app.name}
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Card Type:</span>${app.card_type}
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Email:</span>${app.email}
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Phone:</span>${app.phone}
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">City/Town:</span>${app.city}
                        </div>
                    </div>
                    <div class="application-actions">
                        <button class="approve-btn" onclick="approveApplication('${app.id}')">Approve</button>
                        <button class="reject-btn" onclick="showRejectConfirmation('${app.id}')">Reject</button>
                    </div>
                </div>
            `).join('');
        }

        // Show Reject Confirmation Modal
        function showRejectConfirmation(applicationId) {
            currentApplicationToReject = applicationId;
            confirmationModal.style.display = 'block';
        }

        // Handle Confirm Reject
        async function handleConfirmReject() {
            if (!currentApplicationToReject) return;

            confirmationModal.style.display = 'none';
            showLoading();

            try {
                // Get application data first
                const application = membershipApplications.find(app => app.id === currentApplicationToReject);
                
                if (!application) {
                    throw new Error('Application not found');
                }

                // Delete photo from storage if exists
                if (application.photo_url) {
                    const photoPath = application.photo_url.split('/').pop();
                    await supabaseClient.storage
                        .from('client-photos')
                        .remove([photoPath]);
                }

                // Delete application from database
                const { error } = await supabaseClient
                    .from('applications')
                    .delete()
                    .eq('id', currentApplicationToReject);

                if (error) throw error;

                alert('Application rejected successfully!');
                await loadApplications();

            } catch (error) {
                console.error('Error rejecting application:', error);
                alert('Error rejecting application: ' + error.message);
            } finally {
                hideLoading();
                currentApplicationToReject = null;
            }
        }

        // Handle Cancel Reject
        function handleCancelReject() {
            confirmationModal.style.display = 'none';
            currentApplicationToReject = null;
        }

        // Approve Application with Confirmation Dialog
        async function approveApplication(applicationId) {
            // Show confirmation dialog first - before anything else
            const confirmed = await showConfirmationDialog();
            
            if (!confirmed) {
                return; // Stop function execution if user clicks "No"
            }
            
            showLoading();
            
            try {
                // Get application data
                const application = membershipApplications.find(app => app.id === applicationId);
                
                if (!application) {
                    throw new Error('Application not found');
                }
                
                // Calculate dates
                const fromDate = new Date();
                const toDate = new Date(fromDate);
                toDate.setMonth(toDate.getMonth() + 6);
                
                // Format dates as dd/mm/yyyy
                const formatDateString = (date) => {
                    const day = String(date.getDate()).padStart(2, '0');
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const year = date.getFullYear();
                    return `${day}/${month}/${year}`;
                };
                
                // Generate card ID
                const cardPrefixes = { 'GOLD': 'GLD', 'SILVER': 'SLV', 'DIAMOND': 'DMD', 'EMERALD': 'EMD', 'VIP': 'VIP' };
                const cardId = `${cardPrefixes[application.card_type.toUpperCase()] || 'VIP'}-${Math.random().toString().slice(2, 8).replace(/(\d{3})(\d{3})/, '$1-$2')}`;
                
                // Insert into members table
                const { error: insertError } = await supabaseClient
                    .from('members')
                    .insert([{
                        id: application.id,
                        application_date_time: application.application_date_time,
                        card_type: application.card_type,
                        name: application.name,
                        email: application.email,
                        phone: application.phone,
                        city: application.city,
                        photo_url: application.photo_url,
                        fromDate: formatDateString(fromDate),
                        toDate: formatDateString(toDate),
                        cardId: cardId
                    }]);
                
                if (insertError) throw insertError;
                
                // Delete from applications table
                const { error: deleteError } = await supabaseClient
                    .from('applications')
                    .delete()
                    .eq('id', applicationId);
                
                if (deleteError) throw deleteError;
                
                alert('Application approved successfully!');
                await loadApplications();
                await loadMembers();
                
            } catch (error) {
                console.error('Error approving application:', error);
                alert('Error approving application: ' + error.message);
            } finally {
                hideLoading();
            }
        }
        
        // Confirmation dialog function
        function showConfirmationDialog() {
            return new Promise((resolve) => {
                // Create overlay
                const overlay = document.createElement('div');
                overlay.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background-color: rgba(0, 0, 0, 0.5);
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    z-index: 9999;
                `;
                
                // Create dialog box
                const dialog = document.createElement('div');
                dialog.style.cssText = `
                    background-color: white;
                    border-radius: 12px;
                    padding: 30px;
                    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
                    text-align: center;
                    min-width: 300px;
                    max-width: 400px;
                `;
                
                // Create title
                const title = document.createElement('h3');
                title.textContent = 'Confirm Approval';
                title.style.cssText = `
                    margin: 0 0 20px 0;
                    color: #333;
                    font-size: 20px;
                    font-weight: 600;
                `;
                
                // Create button container
                const buttonContainer = document.createElement('div');
                buttonContainer.style.cssText = `
                    display: flex;
                    gap: 15px;
                    justify-content: center;
                    margin-top: 20px;
                `;
                
                // Create Yes button
                const yesButton = document.createElement('button');
                yesButton.textContent = 'Yes';
                yesButton.style.cssText = `
                    padding: 10px 20px;
                    border: none;
                    border-radius: 6px;
                    background-color: #4CAF50;
                    color: white;
                    font-size: 16px;
                    cursor: pointer;
                    min-width: 80px;
                `;
                
                // Create No button
                const noButton = document.createElement('button');
                noButton.textContent = 'No';
                noButton.style.cssText = `
                    padding: 10px 20px;
                    border: none;
                    border-radius: 6px;
                    background-color: #f44336;
                    color: white;
                    font-size: 16px;
                    cursor: pointer;
                    min-width: 80px;
                `;
                
                // Add hover effects
                yesButton.addEventListener('mouseenter', () => {
                    yesButton.style.backgroundColor = '#45a049';
                });
                yesButton.addEventListener('mouseleave', () => {
                    yesButton.style.backgroundColor = '#4CAF50';
                });
                
                noButton.addEventListener('mouseenter', () => {
                    noButton.style.backgroundColor = '#da190b';
                });
                noButton.addEventListener('mouseleave', () => {
                    noButton.style.backgroundColor = '#f44336';
                });
                
                // Add click handlers
                yesButton.addEventListener('click', () => {
                    document.body.removeChild(overlay);
                    resolve(true);
                });
                
                noButton.addEventListener('click', () => {
                    document.body.removeChild(overlay);
                    resolve(false);
                });
                
                // Assemble dialog
                buttonContainer.appendChild(yesButton);
                buttonContainer.appendChild(noButton);
                dialog.appendChild(title);
                dialog.appendChild(buttonContainer);
                overlay.appendChild(dialog);
                
                // Add to page
                document.body.appendChild(overlay);
            });
        }

        // Load Members from Database
        async function loadMembers() {
            try {
                const { data, error } = await supabaseClient
                    .from('members')
                    .select('*')
                    .order('application_date_time', { ascending: false });

                if (error) throw error;

                members = data;
                originalMembers = [...data]; // Store original data for filtering
                
                if (!isFiltered) {
                    renderFilteredMembers(members);
                }

            } catch (error) {
                console.error('Error loading members:', error);
                membersList.innerHTML = `<div class="no-members">Error loading members: ${error.message}</div>`;
            }
        }

        // Render Filtered Members
        function renderFilteredMembers(membersToShow) {
            if (membersToShow.length === 0) {
                membersList.innerHTML = '<div class="no-members">No members found</div>';
                return;
            }

            membersList.innerHTML = membersToShow.map((member) => `
                <div class="member-item">
                    <div class="member-header">
                        <div class="member-id">Card ID: ${member.cardId}</div>
                        <div class="member-date">Valid: ${member.fromDate} to ${member.toDate}</div>
                    </div>
                    <div class="member-details">
                        <div class="detail-item">
                            <span class="detail-label">Name:</span>${member.name}
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Card Type:</span>${member.card_type}
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Email:</span>${member.email}
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Phone:</span>${member.phone}
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">City/Town:</span>${member.city}
                        </div>
                    </div>
                    <div class="member-actions">
                        <button class="whatsapp-btn" onclick="sendCardInfo('${member.phone}', '${member.name}', '${member.card_type}', '${member.cardId}')">
                            Send Card Info to Member
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Search by Card ID
        function searchByCardId() {
            const cardId = document.getElementById('cardIdInput').value.trim().toUpperCase();
            const messageDiv = document.getElementById('cardIdMessage');
            
            // Clear previous messages
            messageDiv.style.display = 'none';
            messageDiv.className = 'search-message';
            
            if (!cardId) {
                showSearchMessage('Please enter a Card ID', 'error');
                return;
            }
            
            // Search for the member with matching card ID
            const foundMember = originalMembers.find(member => 
                member.cardId.toUpperCase() === cardId
            );
            
            if (foundMember) {
                // Display only the found member
                renderFilteredMembers([foundMember]);
                showSearchMessage(`Found member: ${foundMember.name}`, 'success');
                isFiltered = true;
            } else {
                // Show "Card not found" message
                showSearchMessage('Card not found', 'error');
                renderFilteredMembers([]);
            }
        }

        // Filter by Card Type
        function filterByCardType() {
            const selectedType = document.getElementById('cardTypeFilter').value;
            
            if (!selectedType) {
                // Show all members if no type selected
                resetFilters();
                return;
            }
            
            // Filter members by card type
            const filteredMembers = originalMembers.filter(member => 
                member.card_type.toUpperCase() === selectedType.toUpperCase()
            );
            
            renderFilteredMembers(filteredMembers);
            
            const messageDiv = document.getElementById('cardIdMessage');
            if (filteredMembers.length > 0) {
                showSearchMessage(`Found ${filteredMembers.length} ${selectedType} member(s)`, 'success');
            } else {
                showSearchMessage(`No ${selectedType} members found`, 'error');
            }
            
            isFiltered = true;
        }

        // Reset Filters
        function resetFilters() {
            // Clear inputs
            document.getElementById('cardIdInput').value = '';
            document.getElementById('cardTypeFilter').value = '';
            
            // Hide message
            const messageDiv = document.getElementById('cardIdMessage');
            messageDiv.style.display = 'none';
            
            // Show all members
            renderFilteredMembers(originalMembers);
            isFiltered = false;
        }

        // Show Search Message
        function showSearchMessage(message, type) {
            const messageDiv = document.getElementById('cardIdMessage');
            messageDiv.textContent = message;
            messageDiv.className = `search-message ${type}`;
            messageDiv.style.display = 'block';
            
            // Auto-hide success messages after 3 seconds
            if (type === 'success') {
                setTimeout(() => {
                    messageDiv.style.display = 'none';
                }, 3000);
            }
        }

        // Send Card Info via WhatsApp
        function sendCardInfo(phone, name, cardType, cardId) {
            const message = `Hi ${name}! We have Approved your ${cardType} card application. Use the card code in our website to collect it. Thank you! CARD CODE: ${cardId}. (Please contact for technical support)`;
            const encodedMessage = encodeURIComponent(message);
            
            // Clean phone number (remove any non-digit characters except +)
            const cleanPhone = phone.replace(/[^\d+]/g, '');
            
            const whatsappUrl = `https://wa.me/${cleanPhone}?text=${encodedMessage}`;
            window.open(whatsappUrl, '_blank');
        }

        // Clean up Expired Members
        async function cleanupExpiredMembers() {
            try {
                const today = new Date();
                const todayString = `${String(today.getDate()).padStart(2, '0')}/${String(today.getMonth() + 1).padStart(2, '0')}/${today.getFullYear()}`;
                
                // Get expired members
                const { data: expiredMembers, error: fetchError } = await supabaseClient
                    .from('members')
                    .select('*');

                if (fetchError) throw fetchError;

                if (expiredMembers && expiredMembers.length > 0) {
                    const toDeleteMembers = expiredMembers.filter(member => {
                        const [day, month, year] = member.toDate.split('/');
                        const memberExpiry = new Date(year, month - 1, day);
                        return memberExpiry < today;
                    });

                    console.log(`Found ${toDeleteMembers.length} expired members to cleanup`);

                    // Delete each expired member
                    for (const member of toDeleteMembers) {
                        try {
                            // Delete photo from storage if exists
                            if (member.photo_url) {
                                const photoPath = member.photo_url.split('/').pop();
                                await supabaseClient.storage
                                    .from('client-photos')
                                    .remove([photoPath]);
                            }

                            // Delete member from database
                            await supabaseClient
                                .from('members')
                                .delete()
                                .eq('id', member.id);

                            console.log(`Cleaned up expired member: ${member.name}`);
                        } catch (cleanupError) {
                            console.error(`Error cleaning up member ${member.name}:`, cleanupError);
                        }
                    }

                    // Reload members if any were cleaned up
                    if (toDeleteMembers.length > 0) {
                        await loadMembers();
                    }
                }

            } catch (error) {
                console.error('Error during member cleanup:', error);
            }
        }
        
        // Setup events form
        function setupEventsForm() {
            // Setup character counters with updated limits
            setupCharacterCount(eventName, eventNameCount, 40);
            setupCharacterCount(document.getElementById('videoTitle'), videoTitleCount, 40);
            setupCharacterCount(document.getElementById('testimonialTitle'), testimonialTitleCount, 40);
            
            // Poster upload preview
            posterUpload.addEventListener('change', handlePosterUpload);
            
            // Form validation
            startDate.addEventListener('change', validateDates);
            endDate.addEventListener('change', validateDates);
            
            // Form submission
            eventsForm.addEventListener('submit', handleEventSubmission);
        }
        
        function handlePosterUpload(event) {
            const file = event.target.files[0];
            
            if (!file) {
                selectedPoster = null;
                posterPreview.innerHTML = '';
                return;
            }
            
            // Validate file type
            if (!file.type.startsWith('image/')) {
                showEventStatus('Please select a valid image file.', 'error');
                posterUpload.value = '';
                return;
            }
            
            // Validate file size (max 5MB)
            if (file.size > 20 * 1024 * 1024) {
                showEventStatus('Image size should be less than 20MB.', 'error');
                posterUpload.value = '';
                return;
            }
            
            selectedPoster = file;
            
            // Create preview
            const reader = new FileReader();
            reader.onload = (e) => {
                posterPreview.innerHTML = `
                    <div class="preview-item">
                        <img src="${e.target.result}" alt="Event Poster Preview">
                        <button type="button" class="remove-image" onclick="removePosterPreview()">×</button>
                    </div>
                `;
            };
            reader.readAsDataURL(file);
        }
        
        function removePosterPreview() {
            selectedPoster = null;
            posterPreview.innerHTML = '';
            posterUpload.value = '';
        }
        
        function validateDates() {
            const start = new Date(startDate.value);
            const end = new Date(endDate.value);
            
            if (start && end && start > end) {
                showEventStatus('End date must be after start date.', 'error');
                endDate.value = '';
            }
        }
        
        async function handleEventSubmission(event) {
            event.preventDefault();
            
            // Check event limit
            const currentEventCount = await countEvents();
            if (currentEventCount >= maxEvents) {
                showEventStatus(`You have reached the maximum limit of ${maxEvents} events. Please delete some events before adding more.`, 'error');
                return;
            }
            
            if (!selectedPoster) {
                showEventStatus('Please select a poster image.', 'error');
                return;
            }
            
            showLoading();
            showEventStatus('Posting event...', '');
            postEventBtn.disabled = true;
            
            try {
                await uploadEvent();
                
                // Clear form
                eventsForm.reset();
                removePosterPreview();
                eventNameCount.textContent = '0/40';
                
                showEventStatus('Event posted successfully!', 'success');
                await loadEvents();
                
            } catch (error) {
                console.error('Error posting event:', error);
                if (error.message.includes('RLS')) {
                    showEventStatus('Access denied. You do not have permission to post events.', 'error');
                } else {
                    showEventStatus('Failed to post event: ' + error.message, 'error');
                }
            } finally {
                hideLoading();
                postEventBtn.disabled = false;
            }
        }
        
        async function uploadEvent() {
            // Generate unique ID
            const eventId = crypto.randomUUID();
            
            // Upload poster to storage
            const fileExt = selectedPoster.name.split('.').pop();
            const fileName = `${eventId}.${fileExt}`;
            const filePath = `public/${fileName}`;
            
            const { error: uploadError } = await supabaseClient.storage
                .from('events')
                .upload(filePath, selectedPoster);
                
            if (uploadError) throw uploadError;
            
            // Get public URL
            const { data } = supabaseClient.storage
                .from('events')
                .getPublicUrl(filePath);
                
            const publicUrl = data.publicUrl;
            
            // Insert event data
            const { error: dbError } = await supabaseClient
                .from('events')
                .insert([{
                    id: eventId,
                    event_name: eventName.value,
                    location: eventLocation.value,
                    mode: eventMode.value,
                    start_date: startDate.value,
                    end_date: endDate.value,
                    registration_link: registrationLink.value,
                    poster_path: filePath,
                    poster_url: publicUrl,
                    created_at: new Date().toISOString()
                }]);
                
            if (dbError) throw dbError;
        }
        
        async function loadEvents() {
            try {
                const { data, error } = await supabaseClient
                    .from('events')
                    .select('*')
                    .order('start_date', { ascending: true });
                
                if (error) throw error;
                
                renderEvents(data);
                
            } catch (error) {
                console.error('Error loading events:', error);
                eventsGrid.innerHTML = `<div class="no-events">Error loading events: ${error.message}</div>`;
            }
        }
        
        function renderEvents(events) {
            if (events.length === 0) {
                eventsGrid.innerHTML = '<div class="no-events">No events posted yet.</div>';
                return;
            }
            
            eventsGrid.innerHTML = events.map(event => `
                <div class="event-card">
                    <img src="${event.poster_url}" alt="${event.event_name}" class="event-poster" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjIwMCIgdmlld0JveD0iMCAwIDMwMCAyMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIzMDAiIGhlaWdodD0iMjAwIiBmaWxsPSIjRjhGOUZBIi8+Cjx0ZXh0IHg9IjE1MCIgeT0iMTAwIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmaWxsPSIjNkI3Mjg0IiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTQiPkV2ZW50IFBvc3RlcjwvdGV4dD4KPC9zdmc+'">
                    <div class="event-info">
                        <div class="event-name">${event.event_name}</div>
                        <div class="event-details"><strong>Location:</strong> ${event.location}</div>
                        <div class="event-details"><strong>Mode:</strong> ${event.mode.charAt(0).toUpperCase() + event.mode.slice(1)}</div>
                        <div class="event-details"><strong>Start:</strong> ${formatEventDate(event.start_date)}</div>
                        <div class="event-details"><strong>End:</strong> ${formatEventDate(event.end_date)}</div>
                        <div class="event-details"><strong>Registration:</strong> <a href="${event.registration_link}" target="_blank" style="color: #ff6b35;">View Form</a></div>
                    </div>
                    <div class="event-actions">
                        <button class="delete-btn" onclick="deleteEvent('${event.id}', '${event.event_name}')">Delete</button>
                    </div>
                </div>
            `).join('');
        }
        
        function formatEventDate(dateString) {
            return new Date(dateString).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }
        
        async function deleteEvent(eventId, eventName) {
            if (!confirm(`Are you sure you want to delete the event "${eventName}"?`)) {
                return;
            }
            
            showLoading();
            
            try {
                // Get event data first
                const { data: event, error: fetchError } = await supabaseClient
                    .from('events')
                    .select('*')
                    .eq('id', eventId)
                    .single();
                
                if (fetchError) throw fetchError;
                
                // Delete poster from storage
                const { error: storageError } = await supabaseClient.storage
                    .from('events')
                    .remove([event.poster_path]);
                    
                if (storageError) console.error('Error deleting poster:', storageError);
                
                // Delete event from database
                const { error: dbError } = await supabaseClient
                    .from('events')
                    .delete()
                    .eq('id', eventId);
                    
                if (dbError) throw dbError;
                
                showEventStatus('Event deleted successfully!', 'success');
                await loadEvents();
                
            } catch (error) {
                console.error('Error deleting event:', error);
                showEventStatus('Failed to delete event: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }
        
        async function countEvents() {
            try {
                const { count, error } = await supabaseClient
                    .from('events')
                    .select('*', { count: 'exact', head: true });
                
                if (error) throw error;
                return count || 0;
                
            } catch (error) {
                console.error('Error counting events:', error);
                return 0;
            }
        }
        
        
        async function cleanupExpiredEvents() {
            try {
                const today = new Date();
                const yesterday = new Date(today);
                yesterday.setDate(yesterday.getDate() - 1);
                
                // Get expired events (end date is before yesterday)
                const { data: expiredEvents, error: fetchError } = await supabaseClient
                    .from('events')
                    .select('*')
                    .lt('end_date', yesterday.toISOString().split('T')[0]);
                
                if (fetchError) throw fetchError;
                
                if (expiredEvents && expiredEvents.length > 0) {
                    console.log(`Found ${expiredEvents.length} expired events to cleanup`);
                    
                    // Delete each expired event
                    for (const event of expiredEvents) {
                        try {
                            // Delete poster from storage
                            await supabaseClient.storage
                                .from('events')
                                .remove([event.poster_path]);
                            
                            // Delete event from database
                            await supabaseClient
                                .from('events')
                                .delete()
                                .eq('id', event.id);
                                
                            console.log(`Cleaned up expired event: ${event.event_name}`);
                        } catch (cleanupError) {
                            console.error(`Error cleaning up event ${event.event_name}:`, cleanupError);
                        }
                    }
                    
                    // Reload events after cleanup
                    await loadEvents();
                }
                
            } catch (error) {
                console.error('Error during cleanup:', error);
            }
        }
        
        function showEventStatus(message, type) {
            eventStatus.innerHTML = message;
            eventStatus.className = 'status-message ' + type;
            
            // Clear status after 5 seconds for success messages
            if (type === 'success') {
                setTimeout(() => {
                    eventStatus.innerHTML = '';
                    eventStatus.className = '';
                }, 5000);
            }
        }
    
        // Check authentication state
        async function checkAuth() {
            try {
                const { data: { user }, error } = await supabaseClient.auth.getUser();
                
                if (error) throw error;
                
                if (user) {
                    // User is signed in
                    console.log('User authenticated:', user.email);
                    await initializeDashboard(user);
                } else {
                    // No user is signed in, redirect to login
                    console.log('No user authenticated, redirecting to login');
                    window.location.href = "login.html";
                }
            } catch (error) {
                console.error('Auth check error:', error);
                window.location.href = "login.html";
            }
        }
    
        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            // Show loading initially
            showLoading();
            // Check authentication
            checkAuth();
        });
            
            
        // Videos and Testimonials Management Starts
        const videosForm = document.getElementById('videosForm');
        const videoTitle = document.getElementById('videoTitle');
        const videoLink = document.getElementById('videoLink');
        const videoStatus = document.getElementById('videoStatus');
        const videosGrid = document.getElementById('videosGrid');
        const postVideoBtn = document.getElementById('postVideoBtn');
            
        const testimonialsForm = document.getElementById('testimonialsForm');
        const testimonialTitle = document.getElementById('testimonialTitle');
        const testimonialLink = document.getElementById('testimonialLink');
        const testimonialStatus = document.getElementById('testimonialStatus');
        const testimonialsGrid = document.getElementById('testimonialsGrid');
        const postTestimonialBtn = document.getElementById('postTestimonialBtn');
            
        // YouTube link conversion and validation functions
        function extractVideoId(url) {
            const patterns = [
                /(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([^&\n?#]+)/,
                /youtube\.com\/shorts\/([^&\n?#]+)/
            ];

            for (const pattern of patterns) {
                const match = url.match(pattern);
                if (match) return match[1];
            }
            return null;
        }

        function isYouTubeShorts(url) {
            return url.includes('youtube.com/shorts/') || url.includes('youtu.be/shorts/');
        }

        function isRegularYouTubeVideo(url) {
            const regularPatterns = [
                /youtube\.com\/watch\?v=/,
                /youtu\.be\/(?!shorts)/,
                /youtube\.com\/embed\/(?!.*shorts)/
            ];

            return regularPatterns.some(pattern => pattern.test(url)) && !isYouTubeShorts(url);
        }

        function convertToEmbedLink(url, isShorts = false) {
            const videoId = extractVideoId(url);
            if (!videoId) return null;

            return `https://www.youtube.com/embed/${videoId}`;
        }

        // Updated Videos form submission with shorts validation
        videosForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            // Check if it's a shorts link
            if (isYouTubeShorts(videoLink.value)) {
                showVideoStatus('YouTube Shorts cannot be posted in the Videos section. Please use the Testimonials section for Shorts.', 'error');
                return;
            }

            // Check if it's a valid regular YouTube video
            if (!isRegularYouTubeVideo(videoLink.value)) {
                showVideoStatus('Invalid YouTube video link. Please use a valid YouTube video URL (not Shorts).', 'error');
                return;
            }

            const embedLink = convertToEmbedLink(videoLink.value, false);
            if (!embedLink) {
                showVideoStatus('Invalid YouTube video link. Please use a valid YouTube URL.', 'error');
                return;
            }

            showLoading();
            showVideoStatus('Posting video...', '');
            postVideoBtn.disabled = true;

            try {
                const { error } = await supabaseClient
                    .from('videos')
                    .insert([{
                        title: videoTitle.value,
                        video_link: embedLink,
                        created_at: new Date().toISOString()
                    }]);

                if (error) throw error;
                
                videosForm.reset();
                videoTitleCount.textContent = '0/40';
                showVideoStatus('Video posted successfully!', 'success');
                await loadVideos();
                
            } catch (error) {
                console.error('Error posting video:', error);
                showVideoStatus('Failed to post video: ' + error.message, 'error');
            } finally {
                hideLoading();
                postVideoBtn.disabled = false;
            }
        });

        // Updated Testimonials form submission with regular video validation
        testimonialsForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            // Check if it's a regular YouTube video (not shorts)
            if (isRegularYouTubeVideo(testimonialLink.value)) {
                showTestimonialStatus('Regular YouTube videos cannot be posted in the Testimonials section. Please use the Videos section for regular videos.', 'error');
                return;
            }

            // Check if it's a valid YouTube Shorts link
            if (!isYouTubeShorts(testimonialLink.value)) {
                showTestimonialStatus('Please use a valid YouTube Shorts link (youtube.com/shorts/VIDEO_ID).', 'error');
                return;
            }

            const embedLink = convertToEmbedLink(testimonialLink.value, true);
            if (!embedLink) {
                showTestimonialStatus('Invalid YouTube Shorts link. Please use a valid YouTube Shorts URL.', 'error');
                return;
            }

            showLoading();
            showTestimonialStatus('Posting testimonial...', '');
            postTestimonialBtn.disabled = true;

            try {
                const { error } = await supabaseClient
                    .from('testimonials')
                    .insert([{
                        title: testimonialTitle.value,
                        testimonial_link: embedLink,
                        created_at: new Date().toISOString()
                    }]);

                if (error) throw error;
                
                testimonialsForm.reset();
                testimonialTitleCount.textContent = '0/40';
                showTestimonialStatus('Testimonial posted successfully!', 'success');
                await loadTestimonials();
                
            } catch (error) {
                console.error('Error posting testimonial:', error);
                showTestimonialStatus('Failed to post testimonial: ' + error.message, 'error');
            } finally {
                hideLoading();
                postTestimonialBtn.disabled = false;
            }
        });

        // Load videos
        async function loadVideos() {
            try {
                const { data, error } = await supabaseClient
                    .from('videos')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) throw error;
                renderVideos(data);

            } catch (error) {
                console.error('Error loading videos:', error);
                videosGrid.innerHTML = `<div class="no-events">Error loading videos: ${error.message}</div>`;
            }
        }

        // Load testimonials
        async function loadTestimonials() {
            try {
                const { data, error } = await supabaseClient
                    .from('testimonials')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) throw error;
                renderTestimonials(data);

            } catch (error) {
                console.error('Error loading testimonials:', error);
                testimonialsGrid.innerHTML = `<div class="no-events">Error loading testimonials: ${error.message}</div>`;
            }
        }

        // Render videos
        function renderVideos(videos) {
            if (videos.length === 0) {
                videosGrid.innerHTML = '<div class="no-events">No videos posted yet.</div>';
                return;
            }

            videosGrid.innerHTML = videos.map(video => `
                <div class="event-card">
                    <div class="event-info">
                        <div class="event-name">Title: ${video.title}</div>
                        <div class="event-details"><strong>Posted on:</strong> ${formatEventDate(video.created_at)}</div>
                        <div class="event-details">
                            <a href="${video.video_link.replace('/embed/', '/watch?v=')}" target="_blank" style="color: #ff6b35;">
                                Click to watch on YouTube
                            </a>
                        </div>
                    </div>
                    <div class="event-actions">
                        <button class="delete-btn" onclick="deleteVideo('${video.id}', '${video.title}')">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        // Render testimonials
        function renderTestimonials(testimonials) {
            if (testimonials.length === 0) {
                testimonialsGrid.innerHTML = '<div class="no-events">No testimonials posted yet.</div>';
                return;
            }

            testimonialsGrid.innerHTML = testimonials.map(testimonial => `
                <div class="event-card">
                    <div class="event-info">
                        <div class="event-name">Title: ${testimonial.title}</div>
                        <div class="event-details"><strong>Posted on:</strong> ${formatEventDate(testimonial.created_at)}</div>
                        <div class="event-details">
                            <a href="${testimonial.testimonial_link.replace('/embed/', '/watch?v=')}" target="_blank" style="color: #ff6b35;">
                                Click to watch on YouTube
                            </a>
                        </div>
                    </div>
                    <div class="event-actions">
                        <button class="delete-btn" onclick="deleteTestimonial('${testimonial.id}', '${testimonial.title}')">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        // Delete video
        async function deleteVideo(videoId, videoTitle) {
            if (!confirm(`Are you sure you want to delete the video "${videoTitle}"?`)) {
                return;
            }

            showLoading();

            try {
                const { error } = await supabaseClient
                    .from('videos')
                    .delete()
                    .eq('id', videoId);

                if (error) throw error;

                showVideoStatus('Video deleted successfully!', 'success');
                await loadVideos();

            } catch (error) {
                console.error('Error deleting video:', error);
                showVideoStatus('Failed to delete video: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // Delete testimonial
        async function deleteTestimonial(testimonialId, testimonialTitle) {
            if (!confirm(`Are you sure you want to delete the testimonial "${testimonialTitle}"?`)) {
                return;
            }

            showLoading();

            try {
                const { error } = await supabaseClient
                    .from('testimonials')
                    .delete()
                    .eq('id', testimonialId);

                if (error) throw error;

                showTestimonialStatus('Testimonial deleted successfully!', 'success');
                await loadTestimonials();

            } catch (error) {
                console.error('Error deleting testimonial:', error);
                showTestimonialStatus('Failed to delete testimonial: ' + error.message, 'error');
            } finally {
                hideLoading();
            }
        }

        // Status message functions
        function showVideoStatus(message, type) {
            videoStatus.innerHTML = message;
            videoStatus.className = 'status-message ' + type;

            if (type === 'success') {
                setTimeout(() => {
                    videoStatus.innerHTML = '';
                    videoStatus.className = '';
                }, 5000);
            }
        }

        function showTestimonialStatus(message, type) {
            testimonialStatus.innerHTML = message;
            testimonialStatus.className = 'status-message ' + type;

            if (type === 'success') {
                setTimeout(() => {
                    testimonialStatus.innerHTML = '';
                    testimonialStatus.className = '';
                }, 5000);
            }
        }
        // Videos and Testimonials Management Ends
        
    </script>
</body>
</html>